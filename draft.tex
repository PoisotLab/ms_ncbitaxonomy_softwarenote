%!TEX TS-program = xelatex
\documentclass[11pt]{article}

\usepackage[english]{babel}

\usepackage{amsmath,amssymb,amsfonts}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{stix2}
\usepackage[scaled]{helvet}
\usepackage[scaled]{inconsolata}

\usepackage{lastpage}

\usepackage{setspace}

\usepackage{ccicons}

\usepackage[hang,flushmargin]{footmisc}

\usepackage{geometry}

\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}

\usepackage{fancyhdr}
\renewcommand{\headrulewidth}{0pt}\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

\makeatletter
\newcounter{tableno}
\newenvironment{tablenos:no-prefix-table-caption}{
  \caption@ifcompatibility{}{
    \let\oldthetable\thetable
    \let\oldtheHtable\theHtable
    \renewcommand{\thetable}{tableno:\thetableno}
    \renewcommand{\theHtable}{tableno:\thetableno}
    \stepcounter{tableno}
    \captionsetup{labelformat=empty}
  }
}{
  \caption@ifcompatibility{}{
    \captionsetup{labelformat=default}
    \let\thetable\oldthetable
    \let\theHtable\oldtheHtable
    \addtocounter{table}{-1}
  }
}
\makeatother

\usepackage{array}
\newcommand{\PreserveBackslash}[1]{\let\temp=\\#1\let\\=\temp}
\let\PBS=\PreserveBackslash

\usepackage[breaklinks=true]{hyperref}
\hypersetup{colorlinks,%
citecolor=blue,%
filecolor=blue,%
linkcolor=blue,%
urlcolor=blue}
\usepackage{url}

\usepackage{caption}
\setcounter{secnumdepth}{0}
\usepackage{cleveref}

\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth
\else\Gin@nat@width\fi}
\makeatother
\let\Oldincludegraphics\includegraphics
\renewcommand{\includegraphics}[1]{\Oldincludegraphics[width=\maxwidth]{#1}}

\usepackage{longtable}
\usepackage{booktabs}

\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}

\newlength{\cslhangindent}
\setlength{\cslhangindent}{1.5em}
\newlength{\csllabelwidth}
\setlength{\csllabelwidth}{3em}
\newenvironment{CSLReferences}[3] % #1 hanging-ident, #2 entry spacing
 {% don't indent paragraphs
  \setlength{\parindent}{0pt}
  % turn on hanging indent if param 1 is 1
  \ifodd #1 \everypar{\setlength{\hangindent}{\cslhangindent}}\ignorespaces\fi
  % set entry spacing
  \ifnum #2 > 0
  \setlength{\parskip}{#2\baselineskip}
  \fi
 }%
 {}
\usepackage{calc} % for \widthof, \maxof
\newcommand{\CSLBlock}[1]{#1\hfill\break}
\newcommand{\CSLLeftMargin}[1]{\parbox[t]{\maxof{\widthof{#1}}{\csllabelwidth}}{#1}}
\newcommand{\CSLRightInline}[1]{\parbox[t]{\linewidth}{#1}}
\newcommand{\CSLIndent}[1]{\hspace{\cslhangindent}#1}\geometry{verbose,letterpaper,tmargin=2.2cm,bmargin=2.2cm,lmargin=2.2cm,rmargin=2.2cm}

\usepackage{lineno}
\usepackage[nolists,noheads]{endfloat}

\pagestyle{plain}

\tolerance=1
\emergencystretch=\maxdimen
\hyphenpenalty=10000
\hbadness=10000

\doublespacing

\fancypagestyle{normal}
{
  \fancyhf{}
  \fancyfoot[R]{\footnotesize\sffamily\thepage\ of \pageref*{LastPage}}
}
\begin{document}
\raggedright
\thispagestyle{empty}
{\Large\bfseries\sffamily Template to prepare preprints and manuscripts
using markdown and github actions}
\vskip 5em

%
\href{https://orcid.org/0000-0002-0735-5184}{Timothée\,Poisot}%
%
\,\textsuperscript{1,2,‡}\quad %
Peregrin\,Took%
%
\,\textsuperscript{3,4}\quad %
Merriadoc\,Brandybuck%
%
\,\textsuperscript{5,4,‡}

\textsuperscript{1}\,Université de
Montréal\quad \textsuperscript{2}\,Québec Centre for Biodiversity
Sciences\quad \textsuperscript{3}\,Inn of the Prancing
Pony\quad \textsuperscript{4}\,Fellowship of the
Ring\quad \textsuperscript{5}\,Green Dragon Inn

\textsuperscript{‡}\,These authors contributed equally to the work\\

\textbf{Correspondance to:}\\
Timothée Poisot --- \texttt{timothee.poisot@umontreal.ca}\\

\vfill
This work is released by its authors under a CC-BY 4.0 license\hfill\ccby\\
Last revision: \emph{\today}

\clearpage
\thispagestyle{empty}

\vfill


        {\bfseries Purpose:}\,This template provides a series of scripts
to render a markdown document into an interactive website and a series
of PDFs.\\%
        {\bfseries Motivation:}\,It makes collaborating on text with
GitHub easier, and means that we never need to think about the
output.\\%
        {\bfseries Internals:}\,GitHub actions and a series of python
scritpts. The markdown is handled with \texttt{pandoc}.\\%
    
\vfill

\clearpage
\linenumbers
\pagestyle{normal}

\texttt{NCBITaxonomy.jl} is a package designed to facilitate the
reconciliation and cleaning of taxonomic names, using a local copy of
the NCBI taxonomic backbone (\textbf{Federhen2012NcbTax?};
\textbf{Schoch2020NcbTax?}); The basic search functions are coupled with
quality-of-life functions including case-insensitive search and custom
fuzzy string matching to facilitate the amount of information that can
be extracted automatically while allowing efficient manual curation and
inspection of results. \texttt{NCBITaxonomy.jl} works with version 1.6
of the Julia programming language (\textbf{Bezanson2017JulFre?}), and
relies on the Apache Arrow format to store a local copy of the NCBI raw
taxonomy files. The design of \texttt{NCBITaxonomy.jl} has been inspired
by similar efforts, like the R package \texttt{taxadb}
(\textbf{Norman2020TaxHig?}), which provides an offline alternative to
packages like \texttt{taxize} (\textbf{Chamberlain2013TaxTax?}).

\hypertarget{statement-of-need}{%
\section{Statement of need}\label{statement-of-need}}

Unambiguously identifying species is a far more challenging task than it
may appear. There are a vast number of reasons for this. Different
databases keep different taxonomic ``backbones,'' \emph{i.e.} different
data structures in which names are mapped to species, and organised in a
hierarchy. Not all names are unique identifiers to groups. For example,
\emph{Io} can either refer to a genus of plants from the aster family,
or to a genus of molluscs; the genus \emph{Mus} (of which the house
mouse \emph{Mus musculus} is a species), contains a sub-genus
\emph{also} named \emph{Mus}. Conversely, the same species can have
several names, which are valid synonyms: for example, the domestic cow
\emph{Bos taurus} admits \emph{Bos primigenius taurus} as a valid
synonym. Taxonomic nomenclature also changes regularly, with groups
being split, merged, or moved to a new position in the tree of life;
this is, notably, a common occurrence with viral taxonomy, each
subsequent version of which can differ markedly from the last; compare,
\emph{e.g} (\textbf{Lefkowitz2018VirTax?}) to
(\textbf{Walker2020ChaVir?}).

To add to the complexity, one must also consider that most taxa names
are at some point manually typed, which has the potential to introduce
additional mistakes in raw data; it is likely to expect that such
mistakes may arise when attempting to write down the (perfectly valid)
names of the bacterial isolate known as \emph{Myxococcus
llanfairpwllgwyngyllgogerychwyrndrobwllllantysiliogogogochensis}, or of
the crowned slaty flycatcher \emph{Griseotyrannus
aurantioatrocristatus}. These mistakes are more likely when dealing with
hyper-diverse samples, like plant census (\textbf{Dauncey2016ComMis?};
\textbf{Wagner2016RevSof?}; \textbf{Conti2021MatAlg?}). In addition to
binomial names, the same species can be known by many vernacular
(common) names, which are language or even region-specific: \emph{Ovis
aries}, for example, has valid English vernaculars including lamb,
sheep, wild sheep, and domestic sheep.

All these considerations are actually important when matching species
names both within and across datasets. Let us consider the following
species survey of individual fishes, European chub, \emph{Cyprinus
cephalus}, \emph{Leuciscus cephalus}, \emph{Squalius cephalus}: all are
the same species (\emph{S. cephalus}), referred to as one of the
vernacular (European chub) and two formerly accepted names now
classified as synonyms. A cautious estimate of diversity based on the
user-supplied names would give \(n=4\) species, when there is in fact
only one.

A package with the ability to handle the sources of errors outlined
above, and especially while provide an authoritative classification, can
accelerate the work of consuming large volumes of biodiversity data. For
example, this package was used in the process of developing the
\emph{CLOVER} database (\textbf{Gibb2021DatPro?}) of host-virus
associations, by reconciling the names of viruses and mammals from four
different sources, where all of the issues described above were present.

\hypertarget{overview-of-functionalities}{%
\section{Overview of
functionalities}\label{overview-of-functionalities}}

An up-to-date version of the documentation for \texttt{NCBITaxonomy.jl}
can be found online at
\url{https://docs.ecojulia.org/NCBITaxonomy.jl/stable/}, including
examples and a documentation of every method. The package is released
under the MIT license. Contributions can be made in the form of issues
(bug reports, questions, features suggestions) and pull requests. The
package can be checked out and installed anonymously from the central
Julia repository:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{using}\NormalTok{ Pkg}

\CommentTok{\# This line should go in the Julia configuration file {-} note that the path}
\CommentTok{\# will be created if it doesn\textquotesingle{}t exist, and will be used to store the}
\CommentTok{\# raw taxonomic table}
\ConstantTok{ENV}\NormalTok{[}\StringTok{"NCBITAXONOMY\_PATH"}\NormalTok{] }\OperatorTok{=}\NormalTok{ joinpath(homedir()}\OperatorTok{,} \StringTok{"data"}\OperatorTok{,} \StringTok{"NCBITaxonomy.jl"}\NormalTok{)}

\NormalTok{Pkg.add(}\StringTok{"NCBITaxonomy"}\NormalTok{) }\CommentTok{\# Dowloading the files may take a long time}
\end{Highlighting}
\end{Shaded}

The package will download the most recent version of the NCBI taxonomy
database, and transform in into a set of Apache Arrow files ready for
use. Note that the \texttt{NCBITAXONOMY\_PATH} can specified on a
per-project basis, and as long as the package is not re-built, the local
set of tables downloaded from NCBI will not change; this way, users can
re-run an analysis with a guarantee that the underlying taxonomic
backbone has not changed.

\hypertarget{improved-name-matching}{%
\subsection{Improved name matching}\label{improved-name-matching}}

Name finding is primarily done through the \texttt{taxon} function,
which admits either a unique NCBI identifier (\emph{e.g.}
\texttt{taxon(36219)} for the bogue \emph{Boops boops}), a string
(\texttt{taxon("Boops\ boops")}), or a data frame with a restricted list
of names (see the next section). The \texttt{taxon} method has
additional arguments to perform fuzzy matching in order to catch
possible typos (\texttt{taxon("Boops\ bops";\ strict=false)}), to
perform a lowercase search (useful when alphanumeric codes are part of
the taxon name, like for some viruses), and to restrict the the search
to a specific taxonomic rank.

The lowercase search can be a preferable alternative to fuzzy string
matching. Consider the string \texttt{Adeno-associated\ virus\ 3b} - it
has three names with equal distance (under the Levensthein string
distance function):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{julia}\OperatorTok{\textgreater{}}\NormalTok{ similarnames(}\StringTok{"Adeno{-}associated virus 3b"}\OperatorTok{;}\NormalTok{ threshold}\OperatorTok{=}\FloatTok{0.95}\NormalTok{)}
\FloatTok{3}\OperatorTok{{-}}\NormalTok{element }\DataTypeTok{Vector}\NormalTok{\{}\DataTypeTok{Pair}\NormalTok{\{NCBITaxon}\OperatorTok{,} \DataTypeTok{Float64}\NormalTok{\}\}}\OperatorTok{:}
\NormalTok{  Adeno}\OperatorTok{{-}}\NormalTok{associated virus }\OperatorTok{{-}} \FloatTok{3}\NormalTok{ (ncbi}\OperatorTok{:}\FloatTok{46350}\NormalTok{) }\OperatorTok{=\textgreater{}} \FloatTok{0.96}
\NormalTok{   Adeno}\OperatorTok{{-}}\NormalTok{associated virus }\FloatTok{3}\NormalTok{B (ncbi}\OperatorTok{:}\FloatTok{68742}\NormalTok{) }\OperatorTok{=\textgreater{}} \FloatTok{0.96}
\NormalTok{ Adeno}\OperatorTok{{-}}\NormalTok{associated virus }\FloatTok{3}\NormalTok{A (ncbi}\OperatorTok{:}\FloatTok{1406223}\NormalTok{) }\OperatorTok{=\textgreater{}} \FloatTok{0.96}
\end{Highlighting}
\end{Shaded}

Depending on the operating system, either of these three names can be
returned; compare to the output of a case insensitive name search:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{julia}\OperatorTok{\textgreater{}}\NormalTok{ taxon(}\StringTok{"Adeno{-}associated virus 3b"}\OperatorTok{;}\NormalTok{ casesensitive}\OperatorTok{=}\ExtensionTok{false}\NormalTok{)}
\NormalTok{Adeno}\OperatorTok{{-}}\NormalTok{associated virus }\FloatTok{3}\NormalTok{B (ncbi}\OperatorTok{:}\FloatTok{68742}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

This returns the correct name.

\hypertarget{name-matching-output-and-error-handling}{%
\subsection{Name matching output and error
handling}\label{name-matching-output-and-error-handling}}

The \texttt{taxon} function will either return a \texttt{NCBITaxon}
object (made of a \texttt{name} and \texttt{id}), or throw either a
\texttt{NameHasNoDirectMatch} (with instructions about how to possible
solve it, using the \texttt{similarnames} function), or a
\texttt{NameHasMultipleMatches} (listing the possible valid matches, and
suggesting to use \texttt{alternativetaxa} to find the correct one).
Therefore, the common way to work with the \texttt{taxon} function would
be to wrap it in a \texttt{try}/\texttt{catch} statement:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{try}
\NormalTok{  taxon(name)}
  \CommentTok{\# Additional operations with the matched name}
\KeywordTok{catch}\NormalTok{ err}
  \KeywordTok{if}\NormalTok{ isa(err}\OperatorTok{,}\NormalTok{ NameHasNoDirectMatch)}
    \CommentTok{\# What to do if no match is found}
  \KeywordTok{elseif}\NormalTok{ isa(err}\OperatorTok{,}\NormalTok{ NameHasMultipleMatches)}
    \CommentTok{\# What to do if there are multiple matches}
  \KeywordTok{else}
    \CommentTok{\# What to do in case of another error that is not NCBITaxonomy specific}
  \KeywordTok{end}
\KeywordTok{end}
\end{Highlighting}
\end{Shaded}

These functions will not demand any user input in the form of key
presses (though they can be wrapped in additional code to allow it), as
they are intended to run on clusters without supervision. The
\texttt{taxon} function has good scaling using muliple threads. For
convenience in rapidly getting a taxon for demonstration purposes, we
also provide a string macro, whereby \emph{e.g.}
\texttt{ncbi"Procyon\ lotor"} will return the taxon object for the
raccoon.

\hypertarget{name-filtering-functions}{%
\subsection{Name filtering functions}\label{name-filtering-functions}}

As the full NCBI names table has over 3 million entries at the time of
writing, we have provided a number of functions to restrict the scope of
names that are searched. These are driven by the NCBI \emph{divisions}.
For example \texttt{nf\ =\ mammalfilter(true)} will return a data frame
containing the names of mammals, inclusive of rodents and primates, and
can be used with \emph{e.g.} \texttt{taxon(nf,\ "Pan")}. This has the
dual advantage of making search faster, but also of avoiding matching on
names that are shared by another taxonomic group (which is not an issue
with \emph{Pan}, but is an issue with \emph{e.g.} \emph{Io} as mentioned
in the introduction).

Note that the use of a restricted list of names can have significant
performance consequences: compare, for example, the time taken to return
the taxon \emph{Pan} (ID 9596) in the entire database, in all mammals,
and in all primates:

\begin{longtable}[]{@{}lclll@{}}
\toprule
Names list & Fuzzy matching & Time (ms) & Allocations & Memory
allocated\tabularnewline
\midrule
\endhead
all & no & 23 & 34 & 2 KiB\tabularnewline
& yes & 105 & 2580 & 25 MiB\tabularnewline
\texttt{mammalfilter(true)} & no & 0.55 & 32 & 2 KiB\tabularnewline
& yes & 1.9 & 551 & 286 KiB\tabularnewline
\texttt{primatefilter()} & no & 0.15 & 33 & 2 KiB\tabularnewline
& yes & 0.3 & 92 & 27 KiB\tabularnewline
\bottomrule
\end{longtable}

Clearly, the optimal search strategy is to (i) rely on name filters to
ensure that search are conducted within the appropriate NCBI division,
and (ii) only rely on fuzzy matching when the strict or lowercase match
fails to return a name, as fuzzy matching can result in order of
magnitude more run time and memory footprint. These numbers were
obtained on a single Intel i7-8665U CPU (@ (1.90GHz). Using
\texttt{"chimpanzees"} as the search string (the NCBI recognized
vernacular for \emph{Pan}) gave qualitatively similar results,
suggesting that there is no performance cost associated with working
with synonyms or verncular input data.

\hypertarget{quality-of-life-functions}{%
\subsection{Quality of life functions}\label{quality-of-life-functions}}

In order to facilitate working with names, we provide the
\texttt{authority} function (gives the full taxonomic authority for a
name), \texttt{synonyms} (to get alternative valid names),
\texttt{vernacular} (for English common names), and \texttt{rank} (for
the taxonomic rank).

\hypertarget{taxonomic-lineages-navigation}{%
\subsection{Taxonomic lineages
navigation}\label{taxonomic-lineages-navigation}}

The \texttt{children} function will return all nodes that are directly
descended from a taxon; the \texttt{descendants} function will
recursively apply this function to all descendants of these nodes, until
only terminal leaves are reached. The \texttt{parent} function is an
``upwards'' equivalent, giving that taxon from which a taxon descents;
the \texttt{lineage} function chains calls to \texttt{parent} until
either \texttt{taxon(1)} (the taxonomy root) or an arbitrary ancestor is
reached.

The \texttt{taxonomicdistance} function (and its in-place equivalent,
\texttt{taxonomicdistance!}, which uses memory-efficient re-allocation
if the user needs to change the distance between taxonomic ranks) uses
the (\textbf{Shimatani2001MeaSpe?}) approach to reconstruct a matrix of
distances based on taxonomy, which can serve as a rough proxy when no
phylogenies are available.

\textbf{Acknowledgements:} This work was supported by funding to the
Viral Emergence Research Initiative (VERENA) consortium including NSF
BII 2021909 and a grant from Institut de Valorisation des Données
(IVADO), by the NSERC Discovery Grants and Discovery Acceleration
Supplement programs, and by a donation from the Courtois Foundation.
Benchmarking of this package on distributed systems was enabled by
support provided by Calcul Québec (\texttt{www.calculquebec.ca}) and
Compute Canada (\texttt{www.computecanada.ca}). TP wrote the initial
code, TP and CJC contributed to API design, and all authors contributed
to functionalities and usability testing.

\hypertarget{references}{%
\section{References}\label{references}}

\end{document}
